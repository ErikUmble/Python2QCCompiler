# Alembic Setup and Migration Guide

If you make changes to your models as described in Python - add/remove/modify an attribute (column), add an index, or make another change - the database will need to be updated to reflect those changes. We use `alembic`, which integrates with sqlalchemy and makes this migration process simple and keeps track of the changes that were made with a revision history.

## Step 1: Install Alembic

```bash
pip install alembic
```

## Step 2: Initialize Alembic in your directory

Navigate to the directory of your database:

```bash
cd RandomBooleanFunction
alembic init alembic
```

This creates:
```
RandomBooleanFunction/
├── alembic/
│   ├── env.py          # Migration environment
│   ├── script.py.mako  # Template for new migrations
│   └── versions/       # Migration files go here
└── alembic.ini         # Configuration file
```

## Step 3: Configure the database connection

Edit `alembic.ini` and set your database URL (replace `database.db` with the filename/path of the database):

```ini
# alembic.ini
sqlalchemy.url = sqlite:///database.db
```

## Step 4: Configure env.py to see your models

Edit `alembic/env.py`:

```python
# At the top of the file, add the following:
from benchmarklib import Base 

# Also import your models; for example:
from rbf import RandomBooleanFunction, RandomBooleanFunctionTrial

# Find this line (around line 21):
target_metadata = None

# Change it to:
target_metadata = Base.metadata
```

## Step 5: Generate the initial migration

```bash
alembic revision --autogenerate -m "initial schema"
```

You'll see output like:
```
INFO  [alembic.autogenerate.compare] Detected change x
INFO  [alembic.autogenerate.compare] Detected change x
Generating /path/to/your_directory/alembic/versions/xxxxx_initial_schema.py ... done
```

## Step 6: Review the generated migration

Open the file in `alembic/versions/` and check it looks correct:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.create_table('common_table',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('experiment_data',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('value', sa.Float(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###
```

## Step 7: Apply the migration

```bash
alembic upgrade head
```

You should see:
```
INFO  [alembic.runtime.migration] Running upgrade  -> xxxxx, initial schema
```

## Step 7: Verify it worked

Your database now has:
- The tables you defined
- An `alembic_version` table tracking which migration is current

You can check with:
```bash
alembic current
```

## Making future changes

1. Modify your SQLAlchemy models
2. Run `alembic revision --autogenerate -m "description"`
3. Review the generated migration
4. Run `alembic upgrade head`
5. You can use `alembic check` at any time to verify whether or not the database is synced with the code

## Common issues

**Import errors in env.py**: Make sure your Python path includes the parent directory. You might need to add to `env.py`:
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[2]))
```

**"Target database is not up to date"**: Run `alembic upgrade head` first

**Empty migrations generated**: Check that `target_metadata = Base.metadata` is set correctly and your models are imported

## Project Structure Notes

For multiple databases with shared base classes:
- Use **one Alembic instance per database directory**
- Share the same `DeclarativeBase` across all directories (`from benchmarklib import Base`)
- Each directory imports only the models it needs
- Each Alembic instance manages its own database independently

## What Alembic Autogenerate Detects

**Detects well:**
- Added/removed tables
- Added/removed columns
- Changed column types
- Changed nullable constraints
- Index changes

**May miss:**
- Table/column renames (sees as drop + add)
- Check constraints (limited support)
- Server defaults in some cases
- Custom SQL or data migrations

**Always review generated migrations before applying!**